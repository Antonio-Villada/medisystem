<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- CORRECCIÓN: Cambiado de "Órdenes" a "Fórmulas" -->
    <h2 class="text-primary">Mis Fórmulas</h2>
    <!-- El rol MEDICO vería este botón -->
    <!-- <button class="btn btn-primary">Nueva Fórmula</button> -->
  </div>

  <div *ngIf="formulas$ | async as formulas; else loading">
    <div *ngIf="formulas.length > 0; else noFormulas">

      <table class="table table-hover table-striped shadow-sm">
        <thead class="table-dark">
          <tr>
            <th scope="col">ID Fórmula</th>
            <th scope="col">Fecha</th>
            <th scope="col">ID Cita</th>
            <th scope="col">Nº Medicamentos</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let formula of formulas">
            <td>{{ formula.idFormula }}</td>
            <td>{{ formula.fecha }}</td>
            <td>{{ formula.idCita }}</td>
            <td>{{ formula.detalles.length }}</td>
            <td>
              <button class="btn btn-sm btn-info me-2" (click)="verDetalle(formula)">
                Ver
              </button>
              <!-- El rol MEDICO vería este botón -->
              <!--
              <button class="btn btn-sm btn-outline-secondary" (click)="editarFormula(formula.idFormula)">
                Editar
              </button>
              -->
            </td>
          </tr>
        </tbody>
      </table>

    </div>
    <ng-template #noFormulas>
      <div class="alert alert-info">No se encontraron fórmulas.</div>
    </ng-template>
  </div>
  <ng-template #loading>
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  </ng-template>
</div>

<!-- Modal de Bootstrap para Ver Detalle -->
<div *ngIf="selectedFormula" class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de la Fórmula (ID: {{ selectedFormula.idFormula }})</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <p><strong>Fecha:</strong> {{ selectedFormula.fecha }}</p>
        <p><strong>Cita Asociada (ID):</strong> {{ selectedFormula.idCita }}</p>

        <h6 class="mt-3">Medicamentos Recetados:</h6>
        <ul class="list-group">
          <li *ngFor="let detalle of selectedFormula.detalles" class="list-group-item">
            <strong>{{ detalle.medicamento.nombreMedicamento }}</strong>
            <span class="badge bg-primary rounded-pill ms-2">{{ detalle.cantidad }} Uds.</span>
            <p class="mb-0 text-muted"><small>Dosis: {{ detalle.dosis }}</small></p>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
